<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket Professor - AI Learning Assistant</title>
    <link rel="stylesheet" href="/styles/demo_style.css">
    <!-- SECURITY: Added Subresource Integrity (SRI) hashes. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
            xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6BTzYlEjY/eaMAHQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
            xintegrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <nav>
                <a href="/" class="logo-link">‚¨ÖÔ∏è Back to Main Page</a>
                <ul class="nav-links">
                    <li><a href="/bio.html">About</a></li>
                    <li><a href="/resume.html">Resume</a></li>
                    <li><a href="https://forms.gle/N436zSXQdDGXAMBE7" target="_blank">App Feedback</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">The Pocket Professor</h1>
            <p class="tagline">Your AI-powered learning guide that creates personalized curricula for any subject</p>
        </div>

        <div class="form-container">
            <form id="syllabusForm">
                <!-- Form groups... -->
                <div class="form-group">
                    <label for="subject">What do you want to learn?</label>
                    <input type="text" id="subject" class="form-control" placeholder="e.g., React.js, Data Science, Spanish, Guitar" required>
                </div>
                <div class="form-group">
                    <label for="difficulty">Your current level</label>
                    <select id="difficulty" class="form-control" required>
                        <option value="">Select your level...</option>
                        <option value="complete beginner">Complete Beginner</option>
                        <option value="novice">Novice</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="goal">What's your learning goal?</label>
                    <select id="goal" class="form-control" required>
                        <option value="">Select your goal...</option>
                        <option value="career change">Career Change</option>
                        <option value="get a job">Get a Job</option>
                        <option value="skill improvement">Skill Improvement</option>
                        <option value="academic project">Academic Project</option>
                        <option value="pass certification">Pass Certification</option>
                        <option value="personal interest">Personal Interest</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timeCommitment">How many hours per week can you dedicate?</label>
                    <select id="timeCommitment" class="form-control" required>
                        <option value="">Select time commitment...</option>
                        <option value="2-3 hours">2-3 hours</option>
                        <option value="4-6 hours">4-6 hours</option>
                        <option value="7-10 hours">7-10 hours</option>
                        <option value="10+ hours">10+ hours</option>
                    </select>
                </div>
                <button type="submit" class="btn" id="generateBtn">Generate My Learning Plan üöÄ</button>
                <button type="button" class="btn clear-btn" id="clearFormBtn">Clear Form ‚úñÔ∏è</button>

            </form>
            <div class="error" id="errorMessage"></div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Creating your personalized learning plan...</p>
            <p class="disclaimer">(This may take up to 30 seconds for detailed results)</p>
        </div>

        <div class="results" id="results">
            <h2>Your Personalized Learning Syllabus</h2>
            <button id="downloadPdfBtn" class="btn pdf-btn">‚¨áÔ∏è Download as PDF</button>
            <div class="syllabus-content" id="syllabusContent"></div>
        </div>

        <div class="feedback-prompt" id="feedbackPrompt">    
            <p>Find this tool helpful? I'd love to hear your thoughts -- <a href="https://forms.gle/N436zSXQdDGXAMBE7" target="_blank">Please share your feedback!</a></p>
        </div>

        <div class="back-to-top-container" id="backToTopContainer" style="display:none; margin-top: 10px;">
            <button class="btn" id="backToTopBtn">‚¨ÜÔ∏è Back to Top</button>
        </div>


        <div class="demo-examples">
            <h3>Try these examples:</h3><br>
            <div class="example-buttons">
                <button class="example-btn" onclick="fillExample('react')">Learn React.js</button>
                <button class="example-btn" onclick="fillExample('python')">Python for Data Science</button>
                <button class="example-btn" onclick="fillExample('aws')">AWS Certification</button>
            </div>
        </div>
    </div>

    <script>
    // --- Element Variables ---
    const form = document.getElementById('syllabusForm');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const syllabusContent = document.getElementById('syllabusContent');
    const errorMessage = document.getElementById('errorMessage');
    const generateBtn = document.getElementById('generateBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const feedbackPrompt = document.getElementById('feedbackPrompt');
    let currentCurriculumData = null;

    // --- Sanitization function to escape potentially dangerous characters ---
    function sanitizeInput(str) {
        if (!str) return '';
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .trim();
    }

    // --- Demo Examples ---
    const examples = {
        react: { subject: 'React.js', difficulty: 'novice', goal: 'get a job', timeCommitment: '7-10 hours' },
        python: { subject: 'Python for Data Science', difficulty: 'intermediate', goal: 'career change', timeCommitment: '10+ hours' },
        aws: { subject: 'AWS Cloud Practitioner', difficulty: 'complete beginner', goal: 'pass certification', timeCommitment: '4-6 hours' }
    };

    function fillExample(type) {
        const example = examples[type];
        document.getElementById('subject').value = example.subject;
        document.getElementById('difficulty').value = example.difficulty;
        document.getElementById('goal').value = example.goal;
        document.getElementById('timeCommitment').value = example.timeCommitment;
    }

    function extractHours(timeCommitment) {
        if (timeCommitment.includes('2-3')) return '3';
        if (timeCommitment.includes('4-6')) return '5';
        if (timeCommitment.includes('7-10')) return '8';
        if (timeCommitment.includes('10+')) return '12';
        return '5';
    }

async function downloadSyllabusAsPDF() {
    if (!currentCurriculumData) {
        alert('Please generate a syllabus first before downloading.');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        unit: 'pt',
        format: 'a4'
    });

    const data = currentCurriculumData;

    // --- Configuration ---
    const COLORS = {
        ACCENT: '#7b68ee',
        TEXT: '#333333',
        SUBTLE: '#555555'
    };

    const margin = 40;
    const pageHeight = doc.internal.pageSize.getHeight();
    const usableWidth = doc.internal.pageSize.getWidth() - (margin * 2);
    let y = margin; // This is our master Y-position tracker

    const FONTS = {
        TITLE: 22,
        H1: 16,
        H2: 13,
        BODY: 11
    };
    
    // Base line height, calculated from font size
    const getLineHeight = (fontSize) => fontSize * 1.2;
    const BODY_LINE_HEIGHT = getLineHeight(FONTS.BODY);
    
    // Spacing constants
    const HEADER_MARGIN_BOTTOM = 8;
    const BLOCK_SPACING = 15;

    // --- 1. NEW & MODIFIED HELPERS ---

    /**
     * Checks if a block of a certain height will fit on the current page.
     * If not, adds a new page and resets the Y position.
     */
    const addPageIfNeeded = (heightNeeded) => {
        if (y + heightNeeded > pageHeight - margin) {
            doc.addPage();
            y = margin;
        }
    };

    /**
     * NEW: Helper to estimate the height of a block of text
     */
    const getTextBlockHeight = (text, fontSize, width, indent = 0) => {
        doc.setFontSize(fontSize); // Must set font size for accurate line splitting
        const lines = doc.splitTextToSize(text, width - indent);
        return lines.length * getLineHeight(fontSize);
    };

    /**
     * MODIFIED: Helper functions no longer call addPageIfNeeded.
     * The main loop will now handle all page-break logic.
     */
    const drawTextBlock = (text, fontSize = FONTS.BODY, color = COLORS.TEXT, indent = 0) => {
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(fontSize);
        doc.setTextColor(color);

        const lines = doc.splitTextToSize(text, usableWidth - indent);
        const blockHeight = lines.length * getLineHeight(fontSize);
        
        doc.text(lines, margin + indent, y);
        y += blockHeight + (getLineHeight(fontSize) / 2); // Add text height and a small gap
    };

    const drawHeader = (text, fontSize, color = COLORS.ACCENT) => {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(fontSize);
        doc.setTextColor(color);

        const headerHeight = getLineHeight(fontSize);
        doc.text(text, margin, y);
        y += headerHeight + HEADER_MARGIN_BOTTOM; // Add header height and margin
    };


    // --- 2. MAIN PDF BUILDING LOGIC (Now with "Look-Ahead") ---

    // --- Title ---
    const titleHeight = getLineHeight(FONTS.TITLE);
    addPageIfNeeded(titleHeight); // Check for title
    drawHeader(`Syllabus: ${data.subject}`, FONTS.TITLE);

    // --- Introduction ---
    const introHeight = getTextBlockHeight(data.introduction, FONTS.BODY, usableWidth);
    addPageIfNeeded(introHeight + BLOCK_SPACING); // Check for intro
    drawTextBlock(data.introduction, FONTS.BODY, COLORS.TEXT);
    y += BLOCK_SPACING;

    // --- Prerequisites ---
    if (data.prerequisites?.length) {
        const headerHeight = getLineHeight(FONTS.H1) + HEADER_MARGIN_BOTTOM;
        // Look ahead: Check for header + first item
        const firstItemHeight = getTextBlockHeight(`‚Ä¢ ${data.prerequisites[0]}`, FONTS.BODY, usableWidth, 10);
        addPageIfNeeded(headerHeight + firstItemHeight);
        
        drawHeader('Prerequisites', FONTS.H1);
        
        data.prerequisites.forEach(p => {
            const itemHeight = getTextBlockHeight(`‚Ä¢ ${p}`, FONTS.BODY, usableWidth, 10);
            addPageIfNeeded(itemHeight); // Check for each item
            drawTextBlock(`‚Ä¢ ${p}`, FONTS.BODY, COLORS.SUBTLE, 10);
        });
        y += BLOCK_SPACING;
    }

    // --- Modules ---
    data.modules.forEach(module => {
        const moduleHeaderHeight = getLineHeight(FONTS.H1) + HEADER_MARGIN_BOTTOM;
        
        // Look ahead: Check for Module Header + First Topic Header + First Topic Desc
        let firstTopicHeight = 0;
        if (module.topics[0]) {
            firstTopicHeight += getLineHeight(FONTS.H2) + HEADER_MARGIN_BOTTOM; // Topic header
            firstTopicHeight += getTextBlockHeight(module.topics[0].description, FONTS.BODY, usableWidth); // Topic desc
        }
        addPageIfNeeded(moduleHeaderHeight + firstTopicHeight);
        
        drawHeader(`Week ${module.week}: ${module.title}`, FONTS.H1);

        module.topics.forEach(topic => {
            const topicHeaderHeight = getLineHeight(FONTS.H2) + HEADER_MARGIN_BOTTOM;
            const topicDescHeight = getTextBlockHeight(topic.description, FONTS.BODY, usableWidth);
            
            // Look ahead: Check for Topic Header + Topic Description
            addPageIfNeeded(topicHeaderHeight + topicDescHeight);
            
            drawHeader(topic.topic_name, FONTS.H2, COLORS.TEXT);
            drawTextBlock(topic.description, FONTS.BODY, COLORS.SUBTLE);

            if (topic.resources?.length) {
                const resHeaderHeight = getTextBlockHeight('Resources:', FONTS.BODY, usableWidth, 10);
                const resFirstItemHeight = getTextBlockHeight(`‚Ä¢ ${topic.resources[0]}`, FONTS.BODY, usableWidth, 20);
                
                // Look ahead: Check for "Resources:" + first resource
                addPageIfNeeded(resHeaderHeight + resFirstItemHeight);
                
                drawTextBlock('Resources:', FONTS.BODY, COLORS.TEXT, 10);
                topic.resources.forEach(r => {
                    const resItemHeight = getTextBlockHeight(`‚Ä¢ ${r}`, FONTS.BODY, usableWidth, 20);
                    addPageIfNeeded(resItemHeight); // Check for each resource
                    drawTextBlock(`‚Ä¢ ${r}`, FONTS.BODY, COLORS.SUBTLE, 20);
                });
            }
        });

        if (module.weekly_project) {
            const projectHeaderHeight = getLineHeight(FONTS.H2) + HEADER_MARGIN_BOTTOM;
            const projectDescHeight = getTextBlockHeight(module.weekly_project.description, FONTS.BODY, usableWidth, 10);
            
            // Look ahead: Check for Project Header + Project Description
            addPageIfNeeded(projectHeaderHeight + projectDescHeight);
            
            drawHeader(`Weekly Project: ${module.weekly_project.title}`, FONTS.H2, COLORS.TEXT);
            drawTextBlock(module.weekly_project.description, FONTS.BODY, COLORS.SUBTLE, 10);
        }
        y += BLOCK_SPACING;
    });

    // --- Capstone Project ---
    if (data.capstone_project) {
        const capstoneHeaderHeight = getLineHeight(FONTS.H1) + HEADER_MARGIN_BOTTOM;
        const capstoneTitleHeight = getLineHeight(FONTS.H2) + HEADER_MARGIN_BOTTOM;
        const capstoneDescHeight = getTextBlockHeight(data.capstone_project.description, FONTS.BODY, usableWidth, 10);
        
        // Look ahead: Check for all capstone content
        addPageIfNeeded(capstoneHeaderHeight + capstoneTitleHeight + capstoneDescHeight);
        
        drawHeader('Capstone Project', FONTS.H1);
        drawHeader(data.capstone_project.title, FONTS.H2, COLORS.TEXT);
        drawTextBlock(data.capstone_project.description, FONTS.BODY, COLORS.SUBTLE, 10);
    }

    // --- Save the PDF ---
    doc.save(`Syllabus_${data.subject.replace(/\s+/g, '_')}.pdf`);
}


    function formatCurriculumResponse(curriculum) {
        syllabusContent.innerHTML = ''; 
        
        const titleHeader = document.createElement('h1');
        titleHeader.className = 'syllabus-title';
        // Using .textContent to defend against XSS.
        titleHeader.textContent = `Your Custom Learning Guide -  ${curriculum.subject}`;
        syllabusContent.appendChild(titleHeader);

        const intro = document.createElement('p');
        intro.textContent = curriculum.introduction;
        syllabusContent.appendChild(intro);

        const overviewSection = document.createElement('div');
        overviewSection.className = 'overview-section';

        const prereqColumn = document.createElement('div');
        prereqColumn.className = 'overview-column';
        if (curriculum.prerequisites && curriculum.prerequisites.length > 0) {
            const prereqHeader = document.createElement('h3');
            prereqHeader.textContent = 'Prerequisites';
            prereqColumn.appendChild(prereqHeader);
            const prereqList = document.createElement('ul');
            curriculum.prerequisites.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                prereqList.appendChild(li);
            });
            prereqColumn.appendChild(prereqList);
        }
        overviewSection.appendChild(prereqColumn);

        const breakdownColumn = document.createElement('div');
        breakdownColumn.className = 'overview-column';
        const breakdownHeader = document.createElement('h3');
        breakdownHeader.textContent = 'Weekly Breakdown';
        breakdownColumn.appendChild(breakdownHeader);
        const breakdownList = document.createElement('ul');
        curriculum.modules.forEach(module => {
            const li = document.createElement('li');
            li.textContent = `Week ${module.week}: ${module.title}`;
            breakdownList.appendChild(li);
        });
        breakdownColumn.appendChild(breakdownList);
        overviewSection.appendChild(breakdownColumn);

        syllabusContent.appendChild(overviewSection);

        curriculum.modules.forEach(module => {
            const moduleSection = document.createElement('div');
            moduleSection.className = 'syllabus-section';
            
            const moduleTitle = document.createElement('h3');
            moduleTitle.textContent = `Week ${module.week}: ${module.title}`;
            moduleSection.appendChild(moduleTitle);

            module.topics.forEach(topic => {
                const topicItem = document.createElement('div');
                topicItem.className = 'topic-item';
                
                const topicName = document.createElement('h4');
                topicName.textContent = topic.topic_name;
                topicItem.appendChild(topicName);

                const topicDesc = document.createElement('p');
                topicDesc.textContent = topic.description;
                topicItem.appendChild(topicDesc);

                const resourcesHeader = document.createElement('strong');
                resourcesHeader.textContent = 'Resources:';
                topicItem.appendChild(resourcesHeader);

                const resourcesList = document.createElement('ul');
                topic.resources.forEach(res => {
                    const li = document.createElement('li');
                    li.textContent = res;
                    resourcesList.appendChild(li);
                });
                topicItem.appendChild(resourcesList);
                moduleSection.appendChild(topicItem);
            });

            const projectCard = document.createElement('div');
            projectCard.className = 'project-card';
            const projectHeader = document.createElement('h4');
            projectHeader.textContent = `Weekly Project: ${module.weekly_project.title}`;
            projectCard.appendChild(projectHeader);
            const projectDesc = document.createElement('p');
            projectDesc.textContent = module.weekly_project.description;
            projectCard.appendChild(projectDesc);
            moduleSection.appendChild(projectCard);

            syllabusContent.appendChild(moduleSection);
        });

        const capstoneSection = document.createElement('div');
        capstoneSection.className = 'syllabus-section';
        const capstoneHeader = document.createElement('h3');
        capstoneHeader.textContent = 'Capstone Project';
        capstoneSection.appendChild(capstoneHeader);
        
        const capstoneCard = document.createElement('div');
        capstoneCard.className = 'project-card';
        const capstoneTitle = document.createElement('h4');
        capstoneTitle.textContent = curriculum.capstone_project.title;
        capstoneCard.appendChild(capstoneTitle);
        const capstoneDesc = document.createElement('p');
        capstoneDesc.textContent = curriculum.capstone_project.description;
        capstoneCard.appendChild(capstoneDesc);
        
        capstoneSection.appendChild(capstoneCard);

        syllabusContent.appendChild(capstoneSection);
    }

    // --- Event Listeners ---
    downloadPdfBtn.addEventListener('click', downloadSyllabusAsPDF);

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        results.style.display = 'none';
        feedbackPrompt.style.display = 'none';
        errorMessage.style.display = 'none';
        loading.style.display = 'block';
        generateBtn.disabled = true;

        try {
            const sanitizedSubject = sanitizeInput(document.getElementById('subject').value);
            const sanitizedSkillLevel = sanitizeInput(document.getElementById('difficulty').value);
            const sanitizedGoal = sanitizeInput(document.getElementById('goal').value);
            const timeCommitment = document.getElementById('timeCommitment').value; // Send the string value

            const response = await fetch('https://pocket-professor-backend-production.up.railway.app/generate-curriculum', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subject: sanitizedSubject,
                    skill_level: sanitizedSkillLevel,
                    learning_goal: sanitizedGoal,
                    time_commitment: timeCommitment
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: 'An unknown error occurred.' }));
                throw new Error(`HTTP error! status: ${response.status} - ${errorData.detail}`);
            }

            const curriculumJson = await response.json();
            currentCurriculumData = curriculumJson;
            formatCurriculumResponse(curriculumJson);
            
            loading.style.display = 'none';
            results.style.display = 'block';
            downloadPdfBtn.style.display = 'inline-block';
            feedbackPrompt.style.display = 'block';
            results.scrollIntoView({ behavior: 'smooth' });
            
        } catch (error) {
            console.error('Error generating syllabus:', error);
            loading.style.display = 'none';
            errorMessage.textContent = `Sorry, there was an error generating your syllabus. Please try again: ${error}.`;
            errorMessage.style.display = 'block';
        } finally {
            generateBtn.disabled = false;
        }
    });
</script>

</body>
</html>